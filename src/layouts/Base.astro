---
/**
 * Base Layout
 *
 * Wraps every page with the HTML shell, global CSS, meta tags,
 * and View Transitions for smooth navigation.
 */
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import Slideshow from '@components/Slideshow.astro';
import { ViewTransitions } from 'astro:transitions';
import { getLocaleFromUrl, t } from '@utils/i18n';
import '@styles/global.css';

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  ogImageAlt?: string;
  /** Canonical URL for the page (optional, defaults to current URL) */
  canonicalUrl?: string;
  /** Dynamic accent color derived from image (optional) */
  accentHue?: number;
  accentSaturation?: number;
  accentLightness?: number;
  /** Open Graph type: website (default), article for posts */
  ogType?: 'website' | 'article';
}

const locale = getLocaleFromUrl(Astro.url);
const {
  title = '',
  description = '',
  ogImage = '/og-default.jpg',
  ogImageAlt = '',
  canonicalUrl,
  accentHue,
  accentSaturation,
  accentLightness,
  ogType = 'website',
} = Astro.props;

// Site branding
const siteName = 'Gabriel Mercier Photography';
const defaultDescription = locale === 'fr'
  ? 'Portfolio photographique de Gabriel Mercier — paysages, nature et moments capturés.'
  : 'Photography portfolio by Gabriel Mercier — landscapes, nature, and captured moments.';

// Build canonical URL - use provided or default to current URL (without query params)
const siteUrl = import.meta.env.SITE || Astro.url.origin;
const canonical = canonicalUrl || new URL(Astro.url.pathname, siteUrl).href;
const ogImageUrl = ogImage.startsWith('http') ? ogImage : new URL(ogImage, siteUrl).href;

// Build accent style string if values provided
// Include raw saturation number for calc() usage in CSS
const accentStyle = accentHue !== undefined
  ? `--color-accent-hue: ${accentHue}; --color-accent-saturation: ${accentSaturation}%; --color-accent-lightness: ${accentLightness}%; --saturation-raw: ${accentSaturation};`
  : undefined;

// Title formatting: "Page Title | Site Name" or just "Site Name" for homepage
const pageTitle = title || '';
const fullTitle = pageTitle
  ? (pageTitle.includes('Gabriel') ? pageTitle : `${pageTitle} | ${siteName}`)
  : siteName;

// Description with fallback
const metaDescription = description || defaultDescription;

// Image alt with fallback
const imageAlt = ogImageAlt || pageTitle || siteName;
---

<!doctype html>
<html lang={locale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={metaDescription} />
    <meta name="theme-color" content="#000000" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonical} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:secure_url" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={imageAlt} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content={locale === 'fr' ? 'fr_CA' : 'en_CA'} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonical} />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={imageAlt} />

    <!-- Favicon (placeholder — replace with your own) -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="Gabriel Mercier Photography" href="/rss.xml" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@600&display=swap" rel="stylesheet" />

    <!-- View Transitions for smooth navigation -->
    <ViewTransitions />
  </head>

  <body style={accentStyle}>
    <Header />

    <main id="main-content" class:list={[
      (Astro.url.pathname === '/' || Astro.url.pathname === '/fr/') && 'main--homepage',
      (Astro.url.pathname === '/feed' || Astro.url.pathname === '/feed/' || Astro.url.pathname === '/fr/feed' || Astro.url.pathname === '/fr/feed/') && 'main--fullscreen'
    ]}>
      <slot />
    </main>

    <Footer />
    <Slideshow />
  </body>
</html>

<style>
  /* Page-level layout: header + main + footer */
  body {
    display: flex;
    flex-direction: column;
    min-height: 100dvh;
  }

  main {
    flex: 1;
    padding-top: var(--header-height);
    overflow: visible; /* Allow ambient glow effects to extend */
  }

  /* Remove padding for homepage to allow full-viewport carousel */
  main.main--homepage {
    padding-top: 0;
    background: transparent; /* Ensure no background blocks carousel glow */
  }

  /* Remove padding for fullscreen pages like feed */
  main.main--fullscreen {
    padding-top: 0;
    background: transparent;
  }

  /* Ambient background glow - uses accent color system
   * Creates a subtle gradient that unifies the page
   * Accent colors can be default or page-specific */
  body::before {
    content: '';
    position: fixed;
    inset: -150px;
    background: radial-gradient(
      ellipse 100% 80% at 50% 50%,
      hsla(var(--color-accent-hue), 25%, 55%, 0.12) 0%,
      hsla(var(--color-accent-hue), 20%, 50%, 0.08) 25%,
      hsla(var(--color-accent-hue), 15%, 45%, 0.04) 45%,
      transparent 70%
    );
    z-index: -1;
    pointer-events: none;
    filter: blur(80px);
  }

  /* Hide ambient glow on homepage - carousel has its own dramatic effect */
  body:has(.main--homepage)::before {
    display: none;
  }
</style>
