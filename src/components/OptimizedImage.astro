---
/**
 * OptimizedImage Component
 *
 * Renders a responsive <picture> element with AVIF, WebP, and JPEG sources.
 * Uses the image manifest generated by scripts/optimize-images.ts
 *
 * Features:
 * - Automatic srcset generation for responsive images
 * - Modern format support (AVIF > WebP > JPEG fallback)
 * - Lazy loading with optional eager for above-the-fold
 * - Graceful fallback to original if not optimized
 */

import { getOptimizedImage, imageSizes } from '@utils/optimizedImage';

interface Props {
  /** Original image path (e.g., '/images/uploads/photo.jpg') */
  src: string;
  /** Alt text for accessibility */
  alt: string;
  /** CSS class(es) for the img element */
  class?: string;
  /** Loading strategy: 'lazy' (default) or 'eager' for above-the-fold */
  loading?: 'lazy' | 'eager';
  /** Decoding strategy */
  decoding?: 'async' | 'sync' | 'auto';
  /** Fetch priority for eager images */
  fetchpriority?: 'high' | 'low' | 'auto';
  /** Sizes attribute - use imageSizes preset or custom string */
  sizes?: string;
  /** Additional inline styles */
  style?: string | Record<string, string>;
}

const {
  src,
  alt,
  class: className,
  loading = 'lazy',
  decoding = 'async',
  fetchpriority = 'auto',
  sizes = imageSizes.card,
  style,
} = Astro.props;

// Get optimized image data from manifest
const imageData = await getOptimizedImage(src, sizes);
const hasOptimized = imageData.srcset.avif !== '';

// Convert style to string if object
const styleString = typeof style === 'object'
  ? Object.entries(style).map(([k, v]) => `${k}: ${v}`).join('; ')
  : style;
---

{hasOptimized ? (
  <picture>
    {/* AVIF - best compression, modern browsers */}
    {imageData.srcset.avif && (
      <source
        type="image/avif"
        srcset={imageData.srcset.avif}
        sizes={sizes}
      />
    )}
    {/* WebP - good compression, wide support */}
    {imageData.srcset.webp && (
      <source
        type="image/webp"
        srcset={imageData.srcset.webp}
        sizes={sizes}
      />
    )}
    {/* JPEG fallback */}
    <img
      src={imageData.src}
      alt={alt}
      class={className}
      loading={loading}
      decoding={decoding}
      fetchpriority={loading === 'eager' ? fetchpriority : undefined}
      style={styleString}
    />
  </picture>
) : (
  /* Fallback to original image if not in manifest */
  <img
    src={src}
    alt={alt}
    class={className}
    loading={loading}
    decoding={decoding}
    style={styleString}
  />
)}
