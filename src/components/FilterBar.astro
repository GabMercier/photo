---
/**
 * FilterBar Component
 *
 * Unified filter bar with search, color swatches, and tag pills.
 * Single "All" button resets both color and tag filters.
 * Colors shown as subtle swatches (no labels).
 */
import { getLocaleFromUrl, t } from '@utils/i18n';
import type { ColorFamily } from '@utils/extractColors';

interface Props {
  /** All unique tags across posts */
  tags: string[];
  /** All unique color families present in gallery (optional) */
  colorFamilies?: ColorFamily[];
}

const locale = getLocaleFromUrl(Astro.url);
const { tags, colorFamilies = [] } = Astro.props;

// Color family config with short labels
const colorConfig: Record<ColorFamily, { label: string; color: string }> = {
  red: { label: locale === 'fr' ? 'rouge' : 'red', color: '#e74c3c' },
  orange: { label: 'orange', color: '#e67e22' },
  yellow: { label: locale === 'fr' ? 'jaune' : 'yellow', color: '#f1c40f' },
  green: { label: locale === 'fr' ? 'vert' : 'green', color: '#2ecc71' },
  blue: { label: locale === 'fr' ? 'bleu' : 'blue', color: '#3498db' },
  purple: { label: locale === 'fr' ? 'violet' : 'purple', color: '#9b59b6' },
  neutral: { label: locale === 'fr' ? 'neutre' : 'neutral', color: '#95a5a6' },
};

// Only show color filters if we have multiple families
const showColorFilters = colorFamilies.length > 1;
---

<div class="filter-bar" id="filter-bar">
  <!-- Search input -->
  <div class="filter-bar__search-wrap">
    <svg class="filter-bar__search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <input
      type="text"
      class="filter-bar__search"
      id="gallery-search"
      placeholder={t('gallery.search', locale)}
      autocomplete="off"
    />
  </div>

  <!-- Unified filter row: All + Colors + Tags -->
  <div class="filter-bar__filters" id="filter-pills">
    <!-- Single "All" button that resets everything -->
    <button class="filter-pill filter-pill--all filter-pill--active" data-filter="all" data-type="reset">
      {t('gallery.all', locale)}
    </button>

    <!-- Color pills (small tinted pills, no text) -->
    {showColorFilters && colorFamilies.map((family) => (
      <button
        class="filter-pill filter-pill--color"
        data-filter={family}
        data-type="color"
        style={`--pill-color: ${colorConfig[family].color}`}
        title={colorConfig[family].label}
        aria-label={colorConfig[family].label}
      />
    ))}

    <!-- Separator if we have both colors and tags -->
    {showColorFilters && tags.length > 0 && (
      <span class="filter-bar__separator" aria-hidden="true" />
    )}

    <!-- Tag pills -->
    {tags.map(tag => (
      <button class="filter-pill filter-pill--tag" data-filter={tag} data-type="tag">
        {tag}
      </button>
    ))}
  </div>

  <!-- Active filter count -->
  <div class="filter-bar__count" id="filter-count" aria-live="polite">
    <!-- Populated by JS -->
  </div>
</div>

<script>
  /**
   * Gallery Filter Logic
   *
   * Unified filtering with single "All" reset button.
   * Colors and tags are independent filters that combine (AND logic).
   */
  function initFilters() {
    const filterBar = document.getElementById('filter-bar');
    const searchInput = document.getElementById('gallery-search') as HTMLInputElement;
    const filterPillsContainer = document.getElementById('filter-pills');
    const countDisplay = document.getElementById('filter-count');

    if (!filterBar || !searchInput || !filterPillsContainer || !countDisplay) return;

    const allButton = filterPillsContainer.querySelector<HTMLButtonElement>('[data-type="reset"]');
    const colorButtons = filterPillsContainer.querySelectorAll<HTMLButtonElement>('[data-type="color"]');
    const tagButtons = filterPillsContainer.querySelectorAll<HTMLButtonElement>('[data-type="tag"]');

    let activeTag = 'all';
    let activeColor = 'all';

    // Check URL for pre-selected filters
    const urlParams = new URLSearchParams(window.location.search);
    const urlTag = urlParams.get('tag');
    const urlColor = urlParams.get('color');

    if (urlTag) {
      const decodedTag = decodeURIComponent(urlTag);
      const matchingBtn = Array.from(tagButtons).find(btn => btn.dataset.filter === decodedTag);
      if (matchingBtn) {
        activeTag = decodedTag;
        allButton?.classList.remove('filter-pill--active');
        matchingBtn.classList.add('filter-pill--active');
      }
    }

    if (urlColor && colorButtons.length > 0) {
      const decodedColor = decodeURIComponent(urlColor);
      const matchingBtn = Array.from(colorButtons).find(btn => btn.dataset.filter === decodedColor);
      if (matchingBtn) {
        activeColor = decodedColor;
        allButton?.classList.remove('filter-pill--active');
        matchingBtn.classList.add('filter-pill--active');
      }
    }

    function updateAllButtonState() {
      if (activeTag === 'all' && activeColor === 'all') {
        allButton?.classList.add('filter-pill--active');
      } else {
        allButton?.classList.remove('filter-pill--active');
      }
    }

    /**
     * Apply current filters to all gallery items.
     */
    function applyFilters() {
      const searchText = searchInput.value.toLowerCase().trim();
      const postCards = document.querySelectorAll<HTMLElement>('.post-card');
      const galleryImages = document.querySelectorAll<HTMLElement>('.gallery-image');

      let visibleCount = 0;
      let totalCount = 0;

      // Filter PostCard elements (used in feed)
      postCards.forEach(card => {
        totalCount++;
        const cardTags = (card.dataset.tags || '').toLowerCase();
        const cardTitle = card.querySelector('.post-card__title')?.textContent?.toLowerCase() || '';

        const matchesTag = activeTag === 'all' || cardTags.includes(activeTag);
        const matchesSearch = !searchText ||
          cardTags.includes(searchText) ||
          cardTitle.includes(searchText);

        const isVisible = matchesTag && matchesSearch;

        if (isVisible) {
          card.classList.remove('post-card--hidden');
          visibleCount++;
        } else {
          card.classList.add('post-card--hidden');
        }
      });

      // Filter GalleryImage elements (used in gallery)
      galleryImages.forEach(item => {
        totalCount++;
        const itemTags = (item.dataset.tags || '').toLowerCase();
        const itemTitle = (item.dataset.title || '').toLowerCase();
        const itemColorFamily = item.dataset.colorFamily || '';

        const matchesTag = activeTag === 'all' || itemTags.includes(activeTag);
        const matchesColor = activeColor === 'all' || itemColorFamily === activeColor;
        const matchesSearch = !searchText ||
          itemTags.includes(searchText) ||
          itemTitle.includes(searchText);

        const isVisible = matchesTag && matchesColor && matchesSearch;

        if (isVisible) {
          item.classList.remove('gallery-image--hidden');
          visibleCount++;
        } else {
          item.classList.add('gallery-image--hidden');
        }
      });

      countDisplay.textContent = `${visibleCount} / ${totalCount}`;

      if (postCards.length > 0) {
        updateGalleryLinks();
      }
    }

    function updateGalleryLinks() {
      const visibleCards = document.querySelectorAll<HTMLElement>('.post-card:not(.post-card--hidden)');
      const slugs = Array.from(visibleCards).map(card => {
        const link = card.querySelector<HTMLAnchorElement>('.post-card__link');
        return link?.pathname.split('/').pop() || '';
      }).filter(Boolean);

      sessionStorage.setItem('galleryContext', JSON.stringify({
        slugs: slugs,
        tag: activeTag,
        color: activeColor,
        search: searchInput.value
      }));

      visibleCards.forEach((card, index) => {
        const link = card.querySelector<HTMLAnchorElement>('.post-card__link');
        if (link) {
          const baseUrl = link.pathname;
          link.href = `${baseUrl}?gallery=true&pos=${index}&total=${slugs.length}`;
        }
      });
    }

    // "All" button resets everything
    allButton?.addEventListener('click', () => {
      activeTag = 'all';
      activeColor = 'all';
      tagButtons.forEach(b => b.classList.remove('filter-pill--active'));
      colorButtons.forEach(b => b.classList.remove('filter-pill--active'));
      allButton.classList.add('filter-pill--active');
      applyFilters();
    });

    // Color button click - toggle behavior
    colorButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const clickedColor = btn.dataset.filter || 'all';

        if (btn.classList.contains('filter-pill--active')) {
          // Clicking active color deselects it
          btn.classList.remove('filter-pill--active');
          activeColor = 'all';
        } else {
          // Select new color
          colorButtons.forEach(b => b.classList.remove('filter-pill--active'));
          btn.classList.add('filter-pill--active');
          activeColor = clickedColor;
        }

        updateAllButtonState();
        applyFilters();
      });
    });

    // Tag button click - toggle behavior
    tagButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const clickedTag = btn.dataset.filter || 'all';

        if (btn.classList.contains('filter-pill--active')) {
          // Clicking active tag deselects it
          btn.classList.remove('filter-pill--active');
          activeTag = 'all';
        } else {
          // Select new tag
          tagButtons.forEach(b => b.classList.remove('filter-pill--active'));
          btn.classList.add('filter-pill--active');
          activeTag = clickedTag;
        }

        updateAllButtonState();
        applyFilters();
      });
    });

    // Search input handler (debounced)
    let searchTimeout: ReturnType<typeof setTimeout>;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 200);
    });

    // Initial filter
    updateAllButtonState();
    applyFilters();
  }

  initFilters();
  document.addEventListener('astro:after-swap', initFilters);
</script>

<style>
  .filter-bar {
    margin-bottom: var(--space-2xl);
  }

  /* Search */
  .filter-bar__search-wrap {
    position: relative;
    margin-bottom: var(--space-lg);
  }

  .filter-bar__search-icon {
    position: absolute;
    left: var(--space-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-subtle);
    pointer-events: none;
  }

  .filter-bar__search {
    width: 100%;
    max-width: 400px;
    padding: var(--space-sm) var(--space-lg);
    padding-left: calc(var(--space-md) + 16px + var(--space-sm));
    font-family: var(--font-body);
    font-size: var(--text-sm);
    color: var(--color-text);
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    outline: none;
    transition:
      border-color var(--transition-fast),
      background-color var(--transition-fast);
  }

  .filter-bar__search::placeholder {
    color: var(--color-text-subtle);
  }

  .filter-bar__search:focus {
    border-color: var(--color-accent);
    background-color: var(--color-bg-elevated);
  }

  /* Unified filter row */
  .filter-bar__filters {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-md);
  }

  /* Separator between colors and tags */
  .filter-bar__separator {
    width: 1px;
    height: 16px;
    background-color: var(--color-border);
    margin: 0 var(--space-xs);
  }

  /* Base filter pill styles */
  .filter-pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    font-family: var(--font-body);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    background-color: transparent;
    border: 1px solid var(--color-border);
    border-radius: 20px;
    cursor: pointer;
    transition:
      background-color var(--transition-fast),
      border-color var(--transition-fast),
      color var(--transition-fast),
      opacity var(--transition-fast);
  }

  .filter-pill:hover {
    border-color: var(--color-text-subtle);
    color: var(--color-text);
  }

  .filter-pill--active {
    border-color: var(--color-text);
    color: var(--color-text);
    background-color: var(--color-surface);
  }

  /* Color pills - tinted pills matching "All" button height */
  .filter-pill--color {
    width: 48px;
    min-height: 30px;
    border-color: color-mix(in srgb, var(--pill-color) 30%, var(--color-border));
    background-color: color-mix(in srgb, var(--pill-color) 8%, transparent);
  }

  .filter-pill--color:hover {
    border-color: color-mix(in srgb, var(--pill-color) 60%, var(--color-border));
    background-color: color-mix(in srgb, var(--pill-color) 15%, transparent);
  }

  .filter-pill--color.filter-pill--active {
    border-color: var(--pill-color);
    background-color: color-mix(in srgb, var(--pill-color) 25%, transparent);
  }

  /* Tag pills */
  .filter-pill--tag {
    text-transform: lowercase;
  }

  /* Count */
  .filter-bar__count {
    font-size: var(--text-xs);
    color: var(--color-text-subtle);
    letter-spacing: 0.04em;
  }

  /* Hidden state for filtered items (applied via JS) */
  :global(.post-card--hidden),
  :global(.gallery-image--hidden) {
    display: none !important;
  }
</style>
