---
/**
 * PostCard Component
 * 
 * Displays a post as a card in the feed or gallery grid.
 * Shows cover image with hover overlay containing title, tags, date.
 * 
 * Used by: Feed page, Gallery page, Homepage featured section
 */
import { getLocaleFromUrl, localized, localePath, t } from '@utils/i18n';
import type { CollectionEntry } from 'astro:content';
import OptimizedImage from '@components/OptimizedImage.astro';
import { imageSizes, getOptimizedImage } from '@utils/optimizedImage';

interface Props {
  post: CollectionEntry<'posts'>;
  /** Enable staggered animation (pass index for delay) */
  index?: number;
  /** Aspect ratio variant */
  variant?: 'square' | 'portrait' | 'landscape' | 'auto';
  /** Layout mode: grid (with hover overlay) or feed (metadata below) */
  layout?: 'grid' | 'feed';
}

const locale = getLocaleFromUrl(Astro.url);
const { post, index = 0, variant = 'auto', layout = 'grid' } = Astro.props;
const { title, coverImage, tags, date, postType, glowColor } = post.data;

// Get localized title, or empty string if no title provided
const displayTitle = localized(title, locale);

// Get image data to determine orientation
const imageData = await getOptimizedImage(coverImage.src);
const isPortrait = imageData.aspectRatio < 1;

// Focal point for horizontal cropping of landscape images in portrait containers
// Maps to full object-position value for CSS
const focalPointMap: Record<string, string> = {
  'left': 'left center',
  'center': 'center center',
  'right': 'right center',
};
const focalPoint = focalPointMap[coverImage.focalPoint || 'center'] || 'center center';

// Fallback to cool blue-gray if no color extracted
const glow = glowColor || { r: 58, g: 68, b: 71, hex: '#3A4447' };

// Remove .md extension from post ID
const slug = post.slug || post.id.replace(/\.md$/, '');
const postUrl = localePath(`/posts/${slug}`, locale);
const formattedDate = date.toLocaleDateString(locale === 'fr' ? 'fr-CA' : 'en-CA', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
});
---

<article
  class:list={[
    'post-card',
    `post-card--${variant}`,
    `post-card--${layout}`,
    layout === 'feed' && (isPortrait ? 'post-card--portrait' : 'post-card--landscape'),
    layout === 'grid' && 'animate-in'
  ]}
  style={{
    animationDelay: layout === 'grid' ? `${index * 60}ms` : undefined,
    '--glow-r': glow.r,
    '--glow-g': glow.g,
    '--glow-b': glow.b,
    '--focal-point': focalPoint,
  }}
  data-tags={tags.join(',')}
>
  <a href={postUrl} class="post-card__link" aria-label={displayTitle || t('post.single', locale)}>
    <div class="post-card__image-wrap">
      <OptimizedImage
        src={coverImage.src}
        alt={localized(coverImage.alt, locale)}
        class="post-card__image"
        loading="lazy"
        decoding="async"
        sizes={layout === 'feed' ? imageSizes.feed : imageSizes.gallery}
        style={{ 'object-position': focalPoint }}
      />

      {/* Only show overlay in grid mode */}
      {layout === 'grid' && (
        <div class="post-card__overlay">
          <div class="post-card__overlay-content">
            {displayTitle && <h3 class="post-card__title">{displayTitle}</h3>}
            <div class="post-card__meta">
              <time datetime={date.toISOString()}>{formattedDate}</time>
              {postType === 'series' && (
                <span class="post-card__badge">{t('post.series', locale)}</span>
              )}
            </div>
            <div class="post-card__tags">
              {tags.slice(0, 3).map(tag => (
                <span class="post-card__tag">{tag}</span>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Expand button for feed mode - shows full image in lightbox (mobile only) */}
      {layout === 'feed' && (
        <button
          class="post-card__expand"
          aria-label={t('feed.viewFull', locale)}
          data-full-src={coverImage.src}
          data-full-alt={localized(coverImage.alt, locale)}
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"></polyline>
            <polyline points="9 21 3 21 3 15"></polyline>
            <line x1="21" y1="3" x2="14" y2="10"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
      )}
    </div>

  </a>
</article>

<style>
  .post-card {
    position: relative;
    overflow: hidden;
    border-radius: var(--border-radius);
    background-color: var(--color-surface);
    break-inside: avoid;
    margin-bottom: var(--space-lg);
  }

  .post-card__link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  /* Image */
  .post-card__image-wrap {
    position: relative;
    overflow: hidden;
    display: block;
  }

  .post-card__image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform var(--transition-gallery);
  }

  /* Square variant - force 1:1 aspect ratio */
  .post-card--square .post-card__image-wrap {
    aspect-ratio: 1;
    overflow: hidden;
  }

  /* Picture element must fill container for img to work */
  .post-card--square .post-card__image-wrap :global(picture) {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* Override height: auto from .post-card__image for square variant */
  .post-card--square .post-card__image,
  .post-card--square .post-card__image-wrap :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: var(--focal-point, center center);
  }

  /* Portrait variant - 3:4 aspect ratio cards */
  .post-card--portrait .post-card__image-wrap {
    aspect-ratio: 3 / 4;
    overflow: hidden;
  }

  /* Picture element must fill container for img to work */
  .post-card--portrait .post-card__image-wrap :global(picture) {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* Override height: auto from .post-card__image for portrait variant */
  .post-card--portrait .post-card__image,
  .post-card--portrait .post-card__image-wrap :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    /* Horizontal focal point for landscape images cropped to portrait */
    object-position: var(--focal-point, center center);
  }

  /* Overlay — appears on hover */
  .post-card__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: flex-end;
    padding: var(--space-lg);
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.8) 0%,
      rgba(0, 0, 0, 0.2) 50%,
      transparent 100%
    );
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .post-card:hover .post-card__overlay {
    opacity: 1;
  }

  .post-card__overlay-content {
    transform: translateY(8px);
    transition: transform var(--transition-base);
  }

  .post-card:hover .post-card__overlay-content {
    transform: translateY(0);
  }

  /* Ambient glow effect for grid mode - appears on hover */
  .post-card--grid .post-card__image-wrap::after {
    content: '';
    position: absolute;
    inset: -40px;
    background: radial-gradient(
      ellipse 90% 90% at center,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.18) 0%,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.1) 40%,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.05) 60%,
      transparent 80%
    );
    z-index: -1;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .post-card--grid:hover .post-card__image-wrap::after {
    opacity: 1;
  }

  /* Allow glow to extend beyond for grid mode (but not portrait/square which need cropping) */
  .post-card--grid.post-card--auto .post-card__image-wrap {
    overflow: visible;
  }

  .post-card__title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 400;
    color: #fff;
    margin-bottom: var(--space-xs);
  }

  .post-card__meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-xs);
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: var(--space-sm);
  }

  .post-card__badge {
    padding: 1px 6px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .post-card__tags {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
  }

  .post-card__tag {
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.5);
  }

  .post-card__tag:not(:last-child)::after {
    content: '·';
    margin-left: var(--space-xs);
  }

  /* Parallax container for feed mode */
  .post-card--feed .post-card__image {
    transition: transform 0.1s ease-out;
    will-change: transform;
  }

  @media (prefers-reduced-motion: reduce) {
    .post-card--feed .post-card__image {
      transform: none !important;
    }
  }

  /* Feed-specific layout - full viewport snap */
  .post-card--feed {
    background-color: transparent;
    border-radius: 0;
    overflow: visible; /* Allow glow to extend beyond */
    margin-bottom: 0; /* Remove base margin for proper snap */

    /* Visible area height (viewport minus header) */
    min-height: calc(100vh - var(--header-height));
    height: calc(100vh - var(--header-height));
    padding: 0;
    box-sizing: border-box;

    /* Scroll snap - snap to start for predictable behavior */
    scroll-snap-align: start;
    scroll-snap-stop: always;

    /* Center content vertically - use flex-start to respect padding */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* First card needs extra top space for visual centering */
  .post-card--feed:first-child {
    padding-top: var(--space-3xl);
  }

  /* Fade-in animation initial state */
  .post-card--feed {
    opacity: 0;
    transform: translateY(30px);
    transition:
      opacity 0.6s var(--ease-out-smooth),
      transform 0.6s var(--ease-out-smooth);
  }

  /* Link fills the card and centers image */
  .post-card--feed .post-card__link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }

  /* Visible state - triggered by IntersectionObserver */
  .post-card--feed.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .post-card--feed .post-card__image-wrap {
    border-radius: var(--border-radius);
    position: relative;
    overflow: visible; /* Allow glow to extend beyond */
    isolation: isolate; /* Create stacking context for glow */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Handle picture element from OptimizedImage in feed mode */
  .post-card--feed .post-card__image-wrap :global(picture) {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Base image constraints */
  .post-card--feed .post-card__image-wrap :global(img) {
    position: relative;
    z-index: 1;
    height: 80vh;
    width: auto;
    object-fit: contain;
  }

  /* Landscape images in feed: can be wider */
  .post-card--feed.post-card--landscape .post-card__image-wrap :global(img) {
    max-width: min(95vw, 1300px);
  }

  /* Portrait images in feed: constrain width so they don't tower over everything */
  .post-card--feed.post-card--portrait .post-card__image-wrap :global(img) {
    max-width: min(90vw, 900px);
  }

  /* Ambient glow effect - full viewport width like homepage */
  .post-card--feed .post-card__image-wrap::before {
    content: '';
    position: absolute;
    /* Use viewport-relative positioning to ensure full-width coverage */
    top: -250px;
    bottom: -250px;
    left: 50%;
    transform: translateX(-50%);
    width: 100vw;
    background: radial-gradient(
      ellipse 120% 100% at center,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.18) 0%,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.15) 10%,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.12) 20%,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.09) 30%,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.06) 45%,
      rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0.03) 60%,
      transparent 80%
    );
    z-index: 0;
    pointer-events: none;
    opacity: 1; /* Always visible with scroll-snap */
    filter: blur(60px);
    mix-blend-mode: screen;
  }

  .post-card--feed::after {
    display: none; /* Remove border effect in feed mode */
  }

  /* Respect user preferences - disable scroll-snap smooth behavior */
  @media (prefers-reduced-motion: reduce) {
    .post-card--feed {
      scroll-snap-align: none;
    }
  }

  /* Expand button - hidden by default */
  .post-card__expand {
    display: none;
    position: absolute;
    bottom: var(--space-md);
    right: var(--space-md);
    z-index: 10;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    transition: background var(--transition-fast), transform var(--transition-fast);
  }

  .post-card__expand:hover,
  .post-card__expand:focus {
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.05);
  }

  .post-card__expand:active {
    transform: scale(0.95);
  }

  .post-card__expand svg {
    width: 20px;
    height: 20px;
  }

  /* Mobile - shared styles */
  @media (max-width: 768px) {
    /* Show expand button on mobile */
    .post-card__expand {
      display: flex;
    }
  }

  /* Mobile portrait: crop all images to 3:4 */
  @media (max-width: 768px) and (orientation: portrait) {
    /* All feed images get same container size on mobile portrait */
    .post-card--feed .post-card__image-wrap {
      aspect-ratio: 3 / 4;
      width: 90vw;
      max-width: 500px;
      overflow: visible; /* Keep overflow visible for glow effect */
    }

    /* Picture element fills container and clips content */
    .post-card--feed .post-card__image-wrap :global(picture) {
      width: 100%;
      height: 100%;
      overflow: hidden;
      border-radius: var(--border-radius);
    }

    /* All images fill container with cover */
    .post-card--feed .post-card__image-wrap :global(img) {
      width: 100%;
      height: 100%;
      max-height: none;
      max-width: none;
      object-fit: cover;
      border-radius: var(--border-radius);
      object-position: var(--focal-point, center center);
    }
  }

  /* Mobile landscape: natural image display */
  @media (max-width: 900px) and (orientation: landscape) {
    .post-card--feed {
      min-height: calc(100vh - var(--header-height));
      height: auto;
      padding: var(--space-lg) 0;
    }

    .post-card--feed .post-card__image-wrap {
      aspect-ratio: unset;
      width: auto;
      max-width: 95vw;
    }

    .post-card--feed .post-card__image-wrap :global(img) {
      width: auto;
      height: auto;
      max-height: 70vh;
      max-width: 95vw;
      object-fit: contain;
      border-radius: var(--border-radius);
    }
  }
</style>

<script>
  // Handle expand button clicks to open full image in lightbox
  function initExpandButtons() {
    const expandButtons = document.querySelectorAll('.post-card__expand');

    expandButtons.forEach((button) => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const src = button.dataset.fullSrc;
        const alt = button.dataset.fullAlt;

        if (window.openSlideshow && src) {
          window.openSlideshow([{ src, alt }], 0);
        }
      });
    });
  }

  // Initialize on page load and after view transitions
  document.addEventListener('DOMContentLoaded', initExpandButtons);
  document.addEventListener('astro:after-swap', initExpandButtons);
</script>
