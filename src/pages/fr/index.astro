---
/**
 * Homepage (French)
 *
 * Full-screen carousel showcasing selected photography posts.
 * Uses homepageCarousel frontmatter field to select posts for display.
 */
import Base from '@layouts/Base.astro';
import HomepageCarousel from '@components/HomepageCarousel.astro';
import { getCollection } from 'astro:content';
import { getLocaleFromUrl } from '@utils/i18n';
import { extractDominantColor, deriveAccentFromGlow } from '@utils/extractColors';

const locale = getLocaleFromUrl(Astro.url);

// Fetch posts marked for carousel
const allPosts = await getCollection('posts', ({ data }) => {
  return data.homepageCarousel && !data.draft && !data.private;
});

// Extract glow colors for posts that don't have them
const postsWithColors = await Promise.all(
  allPosts.map(async (post) => {
    // Use existing glowColor from frontmatter if present
    if (post.data.glowColor) {
      return post;
    }

    // Otherwise extract at build time
    const imagePath = post.data.coverImage.src;
    const glowColor = await extractDominantColor(imagePath);

    return {
      ...post,
      data: {
        ...post.data,
        glowColor,
      },
    };
  })
);

// Sort by date (newest first)
const carouselPosts = postsWithColors.sort((a, b) =>
  b.data.date.valueOf() - a.data.date.valueOf()
);

// Find default post
const defaultPost = carouselPosts.find(p => p.data.homepageDefault);
const defaultSlug = defaultPost?.slug;

// Get initial accent from default post or first post
const initialPost = defaultPost || carouselPosts[0];
const initialGlow = initialPost?.data.glowColor || { r: 58, g: 68, b: 71 };
const initialAccent = deriveAccentFromGlow(initialGlow.r, initialGlow.g, initialGlow.b);
---

<Base
  accentHue={carouselPosts.length > 0 ? initialAccent.hue : undefined}
  accentSaturation={carouselPosts.length > 0 ? initialAccent.saturation : undefined}
  accentLightness={carouselPosts.length > 0 ? initialAccent.lightness : undefined}
>
  {carouselPosts.length > 0 ? (
    <HomepageCarousel
      carouselPosts={carouselPosts}
      defaultPostSlug={defaultSlug}
      locale={locale}
    />
  ) : (
    <!-- Fallback if no carousel posts -->
    <section class="hero">
      <div class="container">
        <h1>gpho<span class="hero__dot"></span>to</h1>
      </div>
    </section>
  )}
</Base>

<style>
  .hero {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - var(--header-height));
    text-align: center;
  }

  .hero h1 {
    font-family: 'Urbanist', sans-serif;
    font-weight: 600;
    font-size: clamp(var(--text-4xl), 10vw, 8rem);
    letter-spacing: 0.08em;
    margin-bottom: var(--space-md);
    position: relative;

    /* Translucent interior - barely visible fill */
    background: linear-gradient(
      165deg,
      hsla(var(--color-accent-hue), 10%, 80%, 0.08) 0%,
      hsla(var(--color-accent-hue), 15%, 70%, 0.04) 50%,
      hsla(var(--color-accent-hue), 10%, 80%, 0.08) 100%
    );
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;

    /* Defined glass edge/rim */
    -webkit-text-stroke: 1px hsla(var(--color-accent-hue), 15%, 80%, 0.5);

    /* Subtle glow + chromatic aberration at edges */
    text-shadow:
      0 0 8px hsla(var(--color-accent-hue), 20%, 70%, 0.2),
      -0.5px 0 0 hsla(0, 50%, 70%, 0.15),
      0.5px 0 0 hsla(180, 50%, 70%, 0.15);

    transition:
      text-shadow var(--transition-base),
      -webkit-text-stroke var(--transition-base);
  }

  /* Hover - intensify the glass edge */
  .hero h1:hover {
    -webkit-text-stroke: 1px hsla(var(--color-accent-hue), 20%, 85%, 0.65);
    text-shadow:
      0 0 15px hsla(var(--color-accent-hue), 25%, 70%, 0.3),
      0 0 30px hsla(var(--color-accent-hue), 20%, 70%, 0.15),
      -1px 0 0 hsla(0, 55%, 70%, 0.2),
      1px 0 0 hsla(180, 55%, 70%, 0.2);
  }

  .hero__dot {
    display: inline-block;
    width: 0.12em;
    height: 0.12em;
    margin: 0 0.01em;
    vertical-align: baseline;
    position: relative;
    border-radius: 50%;

    /* Transparent glass - same as header lens */
    background: radial-gradient(
      circle at center,
      hsla(var(--color-accent-hue), 15%, 70%, 0.03) 0%,
      hsla(var(--color-accent-hue), 20%, 60%, 0.08) 70%,
      hsla(var(--color-accent-hue), 25%, 50%, 0.12) 100%
    );

    /* Glass rim */
    border: 1px solid hsla(var(--color-accent-hue), 15%, 80%, 0.4);

    /* Subtle depth and glow */
    box-shadow:
      inset 0 0 4px hsla(var(--color-accent-hue), 10%, 100%, 0.1),
      0 0 8px hsla(var(--color-accent-hue), 20%, 70%, 0.2);

    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }

  .hero__dot::before {
    content: '';
    position: absolute;
    inset: 1px;
    border-radius: 50%;
    background: linear-gradient(
      160deg,
      hsla(var(--color-accent-hue), 10%, 100%, 0.25) 0%,
      hsla(var(--color-accent-hue), 10%, 100%, 0.08) 25%,
      transparent 50%
    );
    pointer-events: none;
  }

  .hero__dot::after {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: 50%;
    box-shadow:
      -0.5px 0 0 hsla(0, 50%, 60%, 0.15),
      0.5px 0 0 hsla(180, 50%, 60%, 0.15);
    pointer-events: none;
    opacity: 0.6;
    transition: opacity var(--transition-base), box-shadow var(--transition-base);
  }

  /* Hover state for dot */
  .hero h1:hover .hero__dot {
    border-color: hsla(var(--color-accent-hue), 20%, 85%, 0.55);
    box-shadow:
      inset 0 0 6px hsla(var(--color-accent-hue), 15%, 100%, 0.15),
      0 0 12px hsla(var(--color-accent-hue), 25%, 70%, 0.3);
  }

  .hero h1:hover .hero__dot::after {
    opacity: 0.9;
    box-shadow:
      -1px 0 0 hsla(0, 55%, 60%, 0.25),
      1px 0 0 hsla(180, 55%, 60%, 0.25);
  }
</style>
