---
/**
 * Feed Page â€” Chronological listing of all public posts
 */
import Base from '@layouts/Base.astro';
import PostCard from '@components/PostCard.astro';
import { getCollection } from 'astro:content';
import { getLocaleFromUrl, t, localePath } from '@utils/i18n';
import { extractDominantColor } from '@utils/extractColors';

const locale = getLocaleFromUrl(Astro.url);

const allPosts = (await getCollection('posts', ({ data }) => {
  return !data.draft && !data.private;
})).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Extract glow colors for posts that don't have them in frontmatter
const posts = await Promise.all(
  allPosts.map(async (post) => {
    // Use existing glowColor from frontmatter if present
    if (post.data.glowColor) {
      return post;
    }

    // Otherwise extract at build time
    const imagePath = post.data.coverImage.src;
    const glowColor = await extractDominantColor(imagePath);

    return {
      ...post,
      data: {
        ...post.data,
        glowColor,
      },
    };
  })
);
---

<Base title={t('nav.feed', locale)}>
  <section class="feed container">
    <div class="feed__content" id="feed-content">
      {posts.map((post) => (
        <PostCard post={post} layout="feed" />
      ))}
    </div>

    {posts.length === 0 && (
      <p class="feed__empty">{t('gallery.noResults', locale)}</p>
    )}
  </section>
</Base>

<script>
  // Scroll-driven reveal animation with IntersectionObserver
  document.addEventListener('astro:page-load', () => {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (prefersReducedMotion) {
      // Skip animations, show all cards immediately
      document.querySelectorAll('.post-card--feed').forEach(card => {
        card.classList.add('visible');
      });
      return;
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
          // Unobserve after animation for performance
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.15,
      rootMargin: '0px 0px -80px 0px' // Start animation before entering viewport
    });

    document.querySelectorAll('.post-card--feed').forEach(card => {
      observer.observe(card);
    });

    // Subtle parallax on scroll
    let ticking = false;

    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          // Parallax on images (very subtle)
          document.querySelectorAll('.post-card--feed .post-card__image').forEach((img) => {
            const card = img.closest('.post-card--feed');
            const rect = card.getBoundingClientRect();
            const inView = rect.top < window.innerHeight && rect.bottom > 0;

            if (inView) {
              const speed = 0.05; // Very subtle
              const yPos = -(rect.top * speed);
              img.style.transform = `translateY(${yPos}px)`;
            }
          });

          ticking = false;
        });

        ticking = true;
      }
    }, { passive: true });
  });
</script>

<style>
  .feed {
    padding-top: var(--space-3xl);
    padding-bottom: var(--space-5xl);
    max-width: none; /* Override container max-width for full-width centering */
  }

  /* Single-column content area - full width to allow card centering */
  .feed__content {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: clamp(var(--space-4xl), 12vw, var(--space-6xl));
  }

  .feed__empty {
    text-align: center;
    color: var(--color-text-muted);
    padding: var(--space-4xl) 0;
  }
</style>
